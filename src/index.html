<!DOCTYPE html>
<html class="no-js" lang="en">
    <head>
        <title>Bootstrap 4 Layout</title>
        <meta http-equiv="x-ua-compatible" content="ie=edge">
	    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,800">
        <link rel='stylesheet' href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="/css/bootstrap.css">
        <link rel="stylesheet" href="/css/styles.css">
    </head>

    <body height="100vh" min-height="100vh">

        <script src="/js/jquery.min.js"></script>
        <script src="/js/popper.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>

        <script src="https://d3js.org/d3.v3.js"></script>

        <script type="application/json" id="mis">
        {
            "nodes": [
            {
                "attributes":
                [
                    {
                        "key": "Id",
                        "value": "f0e305ae-a878-4386-a83a-48e42564b638"
                    },
                    {
                        "key": "Name",
                        "value": "Henrik Vindshøj"
                    },
                    {
                        "key": "Email",
                        "value": "henrik@vindshoej.dk"
                    },
                    {
                        "key": "Phone",
                        "value": "+4520706897"
                    }
               ],
               "group": 1
            },
            {
                "attributes": 
                [
                    {
                        "key": "Id",
                        "value": "00755547-b688-4487-bf94-72189aec828b"
                    },
                    {
                        "key": "Name",
                        "value": "Else Vindshøj"
                    },
                    {
                        "key": "Email",
                        "value": "else@whoelse.dk"
                    }
                ],
               "group": 1
            },
            {
                "attributes": 
                [
                    {
                        "key": "Id",
                        "value": "06d66f0c-6d7c-48d1-8635-dffcb470d88f"
                    },
                    {
                        "key": "Name",
                        "value": "Lauge Vindshøj"
                    },
                    {
                        "key": "Email",
                        "value": "lauge@vindshoej.dk"
                    }
                ],
                "group": 4
            },
            {
                "attributes": 
                [
                    {
                        "key": "Id",
                        "value": "c5959882-61ac-48ad-8bce-a0d5701e29e9"
                    },
                    {
                        "key": "Name",
                        "value": "Crazy Guy"
                    },
                    {
                        "key": "Email",
                        "value": "crazy@hacker.ru"
                    }
                ],
                "group": 2
            }
         ],
         "links": [
            {
               "source": 3,
               "target": 2
            },
            {
               "source": 0,
               "target": 1
            },
            {
               "source": 2,
               "target": 1
            }
         ]
        }</script>

        <script>
        "use strict";

        var rectWidth = 350;
        var lineHeight = 24;
        var textPadding = 12;

        var color = d3.scale.category20();

        var svg = d3.select("body")
            .append("svg")
                .attr("id", "svg")
                .attr("width", "100vw")
                .attr("min-width", "100vw")
                .attr("height", "100vh")
                .attr("min-height", "100vh");

        var width = document.getElementById('svg').clientWidth;
        var height = document.getElementById('svg').clientHeight;

        var force = d3.layout.force()
            .charge(-120)
            .linkDistance(200)
            .size([width, height]);

        var mis = document.getElementById('mis').innerHTML;
        var graph = JSON.parse(mis);

        force.nodes(graph.nodes)
            .links(graph.links)
            .start();

        var link = svg.selectAll(".link")
            .data(graph.links)
            .enter()
            .append("line")
                .attr("class", "link")
                .style("stroke", "rgb(200,200,200)")
                .style("stroke-width", "1");

        var node_drag = d3.behavior.drag()
            .on("dragstart", dragstart)
            .on("drag", dragmove)
            .on("dragend", dragend);
        
        function dragstart(d, i) {
            force.stop() // stops the force auto positioning before you start dragging
        }

        function dragmove(d, i) {
            d.px += d3.event.dx;
            d.py += d3.event.dy;
            d.x += d3.event.dx;
            d.y += d3.event.dy;
        }

        function dragend(d, i) {
            d.fixed = true; // of course set the node to fixed so the force doesn't include the node in its auto positioning stuff
            force.resume();
        }

        function releasenode(d) {
            d.fixed = false; // of course set the node to fixed so the force doesn't include the node in its auto positioning stuff
            force.resume();
        }        

        var nodes = svg.selectAll(".node")
            .data(graph.nodes)
            .enter()
            .append("g")
            .append("svg")
            .on('dblclick', releasenode)
            .call(node_drag);

        var texts = nodes.selectAll("text")
            .data(d => d.attributes)
            .enter()
            .append("text")
                .attr("class", "keyvalue")
                .attr("y", (d, i) =>  lineHeight + i * lineHeight)
                .attr("x", textPadding)
                .text(d => d.key + ": " + d.value);

        var rects = nodes.selectAll("rect")
            .data(d => function(d) { return d; })
            .enter()
            .append("rect")
                .attr("width", 
                    function()
                    {
                        //return this.parentElement.getElementsByClassName("keyvalue").length * lineHeight;
                        return rectWidth;                        
                    })
                .attr("height",
                    function() 
                    { 
                        var numberOfTextElements = this.parentElement.getElementsByClassName("keyvalue").length;
                        return rectangleHeight(numberOfTextElements); 
                    })
                .attr("opacity", "10%");

        force.on(
            "tick", 
            function () 
            {
                link
                    .attr("x1", function (d) { return d.source.x + rectWidth / 2; })
                    .attr("y1", function (d) { return d.source.y + rectangleHeight(d.source.attributes.length) / 2 })
                    .attr("x2", function (d) { return d.target.x + rectWidth / 2; })
                    .attr("y2", function (d) { return d.target.y + rectangleHeight(d.target.attributes.length) / 2 })

                nodes
                    .attr("x", 
                        function (d) 
                        { 
                            return d.x;
                        })
                    .attr("y", function (d) { return d.y; });
                
                nodes.each(collide(0.5));
            });

        function rectangleHeight(numberOfTextElements)
        {
            return numberOfTextElements * lineHeight + textPadding;
        }

        
        var padding = 100,
            radius = 80;

        function collide(alpha) {
            var quadtree = d3.geom.quadtree(graph.nodes);
            return function (d) {
                var rb = 2 * radius + padding,
                    nx1 = d.x - rb,
                    nx2 = d.x + rb,
                    ny1 = d.y - rb,
                    ny2 = d.y + rb;
                quadtree.visit(function (quad, x1, y1, x2, y2) {
                    if (quad.point && (quad.point !== d)) {
                        var x = d.x - quad.point.x,
                            y = d.y - quad.point.y,
                            l = Math.sqrt(x * x + y * y);
                        if (l < rb) {
                            l = (l - rb) / l * alpha;
                            d.x -= x *= l;
                            d.y -= y *= l;
                            quad.point.x += x;
                            quad.point.y += y;
                        }
                    }
                    return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
                });
            };
        }
        
        </script>
    </body>
</html>