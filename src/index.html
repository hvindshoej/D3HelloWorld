<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Bootstrap 4 Layout</title>
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <link rel="stylesheet" href="/css/bootstrap.css">
        <link rel="stylesheet" href="/css/styles.css">
    </head>

    <body> 
        <script src="/js/jquery.min.js"></script>
        <script src="/js/popper.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        <script src="/js/d3.min.js"></script>

        <div class="row">
            <div class="col-sm">
                <div class="input-group m-2">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon1">Aggregate Id</span>
                    </div>
                    <input id="aggregateId" type="text" class="form-control" aria-describedby="basic-addon1">
                </div>            
            </div>
            <div class="col-sm">
                <button type="button" id="getAggregate" class="btn btn-primary m-2">Get Aggregate</button>
            </div>
        </div>

        <table class="table table-sm table-hover table-bordered m-2" id="binding-table">
            <thead>
                <tr>
                    <th>EventType</th>
                    <th>EventDate</th>
                    <th>Sequence</th>
                    <th>Origin</th>
                    <th>EventData</th>
                </tr>
            </thead>
            <tbody id="table_body">
            </tbody>
        </table>

        <svg id="svg" width="100%" height="100vh">
        </svg>

        <script>
            $('#getAggregate').on('click', function(event) {
                event.preventDefault();
                aggregateId = $('#aggregateId').val();

                $.get("https://localhost:44337/api/v1/management/user?id=" + aggregateId, function(data){
                    alert("Data: " + data);
                });

                console.log(aggregateId);

                restart();
            });
        </script>

        <script type="application/json" id="mis">
            {
                "AggregateId": "ceaea287-1796-4d47-9772-bb78543eb3b3",
                "AggregateType": "UserAggregate",
                "AggregateEvents": [{
                        "EventType": "UserCreated",
                        "EventDate": "2019-12-05T19:26:51.7533493+00:00",
                        "EventData": "{\"UserId\":\"ceaea287-1796-4d47-9772-bb78543eb3b3\",\"CountryCode\":\"DK\"}",
                        "Sequence": 0,
                        "Origin": "NewPlatform",
                        "Attributes": [{
                                "Key": "UserId",
                                "Value": "ceaea287-1796-4d47-9772-bb78543eb3b3"
                            },
                            {
                                "Key": "Name",
                                "Value": null
                            },
                            {
                                "Key": "CountryCode",
                                "Value": "DK"
                            },
                            {
                                "Key": "AliasId",
                                "Value": null
                            },
                            {
                                "Key": "IdentityId",
                                "Value": null
                            },
                            {
                                "Key": "Email",
                                "Value": null
                            },
                            {
                                "Key": "IdLevel",
                                "Value": null
                            },
                            {
                                "Key": "IdLevelTime",
                                "Value": null
                            },
                            {
                                "Key": "StateCode",
                                "Value": "Registration"
                            },
                            {
                                "Key": "CreateTime",
                                "Value": null
                            },
                            {
                                "Key": "Blocked",
                                "Value": "False"
                            }
                        ]
                    },
                    {
                        "EventType": "AliasOnUserUpdatedV2",
                        "EventDate": "2019-12-05T19:26:52.0462252+00:00",
                        "EventData": "{\"UserId\":\"ceaea287-1796-4d47-9772-bb78543eb3b3\",\"AliasId\":\"084cea42-6736-4741-bb58-4161c6174bfc\",\"Alias\":\"+4511357173\",\"ChangedBy\":\"ceaea287-1796-4d47-9772-bb78543eb3b3\",\"UpdateTime\":\"2019-12-05T19:26:52.0462252+00:00\"}",
                        "Sequence": 1,
                        "Origin": "NewPlatform",
                        "Attributes": [{
                                "Key": "UserId",
                                "Value": "ceaea287-1796-4d47-9772-bb78543eb3b3"
                            },
                            {
                                "Key": "Name",
                                "Value": null
                            },
                            {
                                "Key": "CountryCode",
                                "Value": "DK"
                            },
                            {
                                "Key": "AliasId",
                                "Value": "084cea42-6736-4741-bb58-4161c6174bfc"
                            },
                            {
                                "Key": "IdentityId",
                                "Value": null
                            },
                            {
                                "Key": "Email",
                                "Value": null
                            },
                            {
                                "Key": "IdLevel",
                                "Value": null
                            },
                            {
                                "Key": "IdLevelTime",
                                "Value": null
                            },
                            {
                                "Key": "StateCode",
                                "Value": "Registration"
                            },
                            {
                                "Key": "CreateTime",
                                "Value": null
                            },
                            {
                                "Key": "Blocked",
                                "Value": "False"
                            }
                        ]
                    }
                ]
            }
        </script>

        <script src="/js/main.js"></script>

        <script>

            function LoadTable(newNode)
            {
                var node = JSON.parse(newNode)
                var aggregateEvents = node.AggregateEvents;

                $(function () 
                {
                    var tbody = $('#table_body');
                    $.each
                    (
                        aggregateEvents, 
                        function (i, item) 
                        {
                            $('<tr>')
                                .append(
                                    $('<td>').text(item.EventType),
                                    $('<td class="EventDate">').text(item.EventDate),
                                    $('<td>').text(item.Sequence),
                                    $('<td>').text(item.Origin),
                                    $('<td>').text(item.EventData))
                                .appendTo(tbody)
                                .on('click', 
                                    function() 
                                    {
                                        aggregateEventDate = $(this).children("td.EventDate").html();
                                        restart();
                                    });
                        }
                    )
                });
            }
        </script>

        <script>
            var mis = document.getElementById('mis').innerHTML;
            $('textarea#newNode').val(mis);
            AddNode(mis);
            LoadTable(mis);
        </script>

    </body>>
</html>